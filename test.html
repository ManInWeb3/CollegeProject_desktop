<!DOCTYPE html>
<html>
<head>
    <title>Writing test application.</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="./css/jquery-ui.min.css">
    
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>


<i id="zoom_in" class="material-icons orange600">zoom_in</i>
<i id="zoom_out" class="material-icons orange600">zoom_out</i>


    <div class="App-header">
      <p id="TestTimer"></p>
      <p id="testStats"></p>
    </div>

    <div class="Main-area">
        <div class="Question-area">
          <p id="TestQuestion"></p>
        </div>

        <div class="Answer-area">
          <textarea id="anstext" >Type your answer here. </textarea>
        </div>

    </div>

    <div class="bpanel">
        <input id="finishTest" value="Finish test" type="button" style="font-size : 110%;" />
    </div>
    <div id="camdemo" style="position: absolute; right: 5px;bottom: 5px; width: 640px; height: 480px; visibility:hidden;"></div>
    <img id="my-preview"/>



<script>window.$ = window.jQuery = require('jquery');</script>

<script src="./js/jquery-ui.min.js"></script>

    <script>

        const APISRV='http://exam.expert-it.org:81/api/v1/';
        var TestRestTime = 100;

        document.getElementById("finishTest").addEventListener("click", 
            function(){testFinish("If you click OK, all your answers will be saved and the application will be closed. After that you will not be able to add/edit your answers.", "Do you want to finish the test.",PIN,"cancel")}
            ,false);

        var PIN=decodeURIComponent(urlParam('pin'));

        setTestInfo(PIN);
//        sendPOST2API(PIN);

        setInterval(function(){sendPOST2API(PIN);}, 30000);
        setInterval(function(){setTimer(PIN);}, 15000);

        setInterval(function(){
            s = document.getElementById("anstext").value;
            s = s.replace(/(^\s*)|(\s*$)/gi,"");
            s = s.replace(/\n /,"\n");
            s = s.replace(/[ ]{2,}/gi," ");
            document.getElementById("testStats").innerHTML = "Number of words: " + s.split(' ').length;},5000
        );

        const {ipcRenderer} = require('electron');

        function testFinish(message,title,PIN,cancel){
// ?????????
//            sendPOST2API(PIN);
            var mbuttons = {};
            mbuttons['Ok'] = function()  {
                        document.getElementById("anstext").readOnly = "true";
                        document.getElementById("TestTimer").innerHTML = message;
                        $( this ).dialog( 'close' );
                        ipcRenderer.send('testFINISHED');
                    };
            if (Boolean(cancel)){
                mbuttons['Cancel']= function()  {
                            $( this ).dialog( 'close' );
                        };
            }

            $('<div></div>').html( message ).dialog({
                title: title,
                    maxWidth:600,
                    width: 400,
                resizable: false,
                modal: true,
                buttons: mbuttons,
                open: function(event, ui) {
                  $(this).closest('.ui-dialog').find('.ui-dialog-titlebar-close').hide();
                },
            });
        }

        function setTimer(PIN){
            // var timeRest = parseInt((testTimeStart+60*testDuration-parseInt(Date.now()/1000,10))/60,10);
            document.getElementById("TestTimer").innerHTML = "You have " + (TestRestTime < 5 ? "<blink><font color='red'>" + TestRestTime + "</font></blink>" : TestRestTime ) + " minutes";
            // Finish test
            if (TestRestTime <= 0) {
                testFinish("Test\'s time is up, all you answers are saved, closing the application.","Test time is up",PIN);
            };
        }

        function urlParam(name, w){
            w = w || window;
            var rx = new RegExp('[\?]'+name+'=([^\#]+)'),
                val = w.location.search.match(rx);
                console.log("Location: " + w.location);

            return !val ? '':val[1];
        }

        function setTestInfo(PIN){
            var request = require('request');
            request.get(APISRV+'test/'+PIN+'/', 
                function(err, response, body) {
                    if (response['statusCode'] == 200) {
                        console.log('Server responded with:', response);
                        data = JSON.parse(body);
                        document.getElementById("TestQuestion").innerHTML = "Question: " + data['question'];
                        TestRestTime = data['resttime'];
                        testTimeStart = parseInt(Date.now()/1000,10);
                        setTimer(PIN);

                    }
            });

        }

        var fs = require('fs');
        const {desktopCapturer, screen} = require('electron');

        var CamOK=1;
        var WebCamera = require("webcamjs");
        WebCamera.attach('#camdemo');
        WebCamera.on( 'error', function(err) {
            console.log("Cannot acces WEBCAM!!!!!!!!!!!!"+err);
            CamOK=0;
        // an error occurred (see 'err')
        } );

        function sendPOST2API(PIN){
                var text = document.getElementById("anstext").value; 
                console.log("### ",PIN);
                if (CamOK) { 
                    WebCamera.snap(function(data_uri) {
                        photoFN = "photo" + Date.now() + ".jpeg";
                        var pimageBuffer = processBase64Image(data_uri);
                        fs.writeFile(photoFN, pimageBuffer.data, function(err) {
                            if(err){
                                console.log("Cannot save the file 1111 time to cry !");
                            }else{
                                console.log("Photo saved succesfully: " + photoFN);
                            }
                        });
                        // return screenshotFN;
                    });
                }
                var request = require('request');
                var FormData = require('form-data');
//
// From http://ourcodeworld.com/articles/read/280/creating-screenshots-of-your-app-or-the-screen-in-electron-framework
//
                fullscreenScreenshot(function(base64data){
                    screenshotFN = "screenshot" + Date.now() + ".jpeg";
                    var simageBuffer = processBase64Image(base64data);
                    fs.writeFile(screenshotFN, simageBuffer.data, 
                        function(err) {
                            if(err){
                                console.log("Cannot save the file 22222 time to cry !");
                            }else{
                                console.log("Screenshot saved succesfully: " + screenshotFN);
                                let formData = {
                                    'text': text,
                                    'screenshot': fs.createReadStream(screenshotFN),
                                    'photo': (CamOK?fs.createReadStream(photoFN):""),
                                };
                                request.post({
                                    url: APISRV+'testlog/bypin/'+PIN+'/',
                                    formData: formData
                                    }, function(err, response, body) {
                                    if (err) {
                                      return console.error('upload failed:', err);
                                    }
                                    console.log('Server responded with:', response);
                                    data = JSON.parse(body);
                                    TestRestTime = data['resttime'];
                                });

                            }
                        }
                    );



                },'image/jpeg');
        }



// BEGIN Take a photo from webcam
//
// FROM http://ourcodeworld.com/articles/read/134/how-to-use-the-camera-with-electron-framework-create-a-snapshot-and-save-the-image-on-the-system
//
            function processBase64Image(dataString) {
              var matches = dataString.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/),response = {};
              if (matches.length !== 3) {
                  return new Error('Invalid input string');
              }
              response.type = matches[1];
              response.data = new Buffer(matches[2], 'base64');
              return response;
            }
//  END Take a photo from webcam

// BEGIN Take a screenshot
//
// FROM http://ourcodeworld.com/articles/read/134/how-to-use-the-camera-with-electron-framework-create-a-snapshot-and-save-the-image-on-the-system
//
function fullscreenScreenshot(callback, imageFormat) {
    var _this = this;
    this.callback = callback;
    imageFormat = imageFormat || 'image/jpeg';
    
    this.handleStream = (stream) => {
        // Create hidden video tag
        var video = document.createElement('video');
        video.style.cssText = 'position:absolute;top:-10000px;left:-10000px;';
        // Event connected to stream
        video.onloadedmetadata = function () {
            // Set video ORIGINAL height (screenshot)
            video.style.height = this.videoHeight + 'px'; // videoHeight
            video.style.width = this.videoWidth + 'px'; // videoWidth

            // Create canvas
            var canvas = document.createElement('canvas');
            canvas.width = this.videoWidth;
            canvas.height = this.videoHeight;
            var ctx = canvas.getContext('2d');
            // Draw video on canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            if (_this.callback) {
                // Save screenshot to base64
                _this.callback(canvas.toDataURL(imageFormat));
            } else {
                console.log('Need callback!');
            }

            // Remove hidden video tag
            video.remove();
            try {
                // Destroy connect to stream
                stream.getTracks()[0].stop();
            } catch (e) {}
        }
        video.src = URL.createObjectURL(stream);
        document.body.appendChild(video);
    };

    this.handleError = function(e) {
        console.log(e);
    };

//
// FROM http://ourcodeworld.com/articles/read/280/creating-screenshots-of-your-app-or-the-screen-in-electron-framework
//

    // Filter only screen type
    desktopCapturer.getSources({types: ['screen']}, (error, sources) => {
        if (error) throw error;
        // console.log(sources);
        for (let i = 0; i < sources.length; ++i) {
            console.log(sources);
            // Filter: main screen
            if (sources[i].name === "Entire screen") {
                navigator.webkitGetUserMedia({
                    audio: false,
                    video: {
                        mandatory: {
                            chromeMediaSource: 'desktop',
                            chromeMediaSourceId: sources[i].id,
                            minWidth: 1280,
                            maxWidth: 4000,
                            minHeight: 720,
                            maxHeight: 4000
                        }
                    }
                }, this.handleStream, this.handleError);

                return;
            }
        }
    });
}

        </script>



<script>
    $(document).ready(function($)
    {
        // Set initial zoom level
        var fsize=14;

        // Click events
        $('#zoom_in').click(function() { zoom_font(1, $(this)) });
        $('#zoom_out').click(function() { zoom_font(-1, $(this)) });
        $('#zoom_reset').click(function() { zoom_font(0, $(this)) });

        // Zoom function
        function zoom_font(step, trigger)
        {
            // Set / reset zoom
            if(step==0) 
		fsize=14;
            else 
		fsize +=step;
            // Set page zoom via CSS
            $('body').css("font-size", fsize);
        }
    });
</script>


<script src="./js/script.js"></script>




</body>
</html>
